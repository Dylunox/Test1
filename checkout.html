<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إتمام الشراء - tkchop.om</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(to bottom, #4B0082, #1C2526);
            color: #FFFFFF;
            direction: rtl;
            overflow-x: hidden;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #FFFFFF;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-top: 5px solid #6A0DAD;
            color: #1a2b3c;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        h1 {
            text-align: center;
            color: #6A0DAD;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .order-summary {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
            margin-bottom: 30px;
        }
        .order-summary h2 {
            font-size: 24px;
            color: #6A0DAD;
            margin: 0 0 15px;
            font-weight: 700;
        }
        #order-details {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow-x: auto;
            background: #FFFFFF;
        }
        #order-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            color: #1a2b3c;
        }
        #order-table th, #order-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        #order-table th {
            background: #6A0DAD;
            color: #FFFFFF;
            font-weight: 700;
        }
        #order-table td img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            vertical-align: middle;
            margin-left: 10px;
        }
        .summary-details {
            margin-top: 20px;
            font-size: 18px;
            color: #1a2b3c;
            background: #f5f6f5;
            padding: 15px;
            border-radius: 8px;
            font-weight: 700;
        }
        .summary-details p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        .summary-details span {
            color: #FF69B4;
        }
        .notes-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f6f5;
            border-radius: 8px;
        }
        .notes-display h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #6A0DAD;
        }
        .checkout-form {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        .checkout-form h2 {
            font-size: 24px;
            color: #6A0DAD;
            margin: 0 0 15px;
            font-weight: 700;
        }
        .form-group {
            position: relative;
            margin-bottom: 20px;
        }
        .form-group input, .form-group textarea {
            display: block;
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #6A0DAD;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: #fafafa;
        }
        .form-group textarea {
            height: 100px;
            resize: none;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: #5A0A9A;
            box-shadow: 0 0 8px rgba(90, 10, 154, 0.3);
            outline: none;
        }
        .form-group::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-size: cover;
        }
        .form-group.name::before {
            background: url('user-icon.png') no-repeat center;
        }
        .form-group.email::before {
            background: url('email-icon.png') no-repeat center;
        }
        .form-group.phone::before {
            background: url('phone-icon.png') no-repeat center;
        }
        .payment-methods {
            margin: 20px 0;
        }
        .payment-methods h3 {
            font-size: 18px;
            color: #6A0DAD;
            margin-bottom: 10px;
        }
        .payment-methods label {
            display: block;
            margin: 10px 0;
            font-size: 16px;
            color: #1a2b3c;
            cursor: pointer;
            transition: color 0.3s;
        }
        .payment-methods label:hover {
            color: #FF69B4;
        }
        .payment-methods input[type="radio"] {
            margin-left: 10px;
        }
        #terms {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }
        #terms label {
            margin-right: 10px;
            font-size: 14px;
            color: #546e7a;
        }
        #terms a {
            color: #6A0DAD;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s;
        }
        #terms a:hover {
            color: #FF69B4;
            text-decoration: underline;
        }
        button {
            background: #6A0DAD;
            color: #FFFFFF;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
        }
        button:hover {
            background: #5A0A9A;
            box-shadow: 0 0 10px rgba(106, 13, 173, 0.7);
            transform: scale(1.02);
        }
        button:disabled {
            background: #90a4ae;
            cursor: not-allowed;
            transform: none;
        }
        .back-btn {
            background: #546e7a;
            margin-top: 20px;
        }
        .back-btn:hover {
            background: #455a64;
        }
        #terms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #terms-modal.active {
            display: block;
            opacity: 1;
        }
        #terms-modal > div {
            background: #FFFFFF;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            border-top: 5px solid #6A0DAD;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            color: #1a2b3c;
        }
        #terms-modal.active > div {
            transform: scale(1);
        }
        #terms-modal h2 {
            margin: 0 0 20px;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            color: #6A0DAD;
        }
        #terms-modal .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #546e7a;
            transition: color 0.3s;
        }
        #terms-modal .close-btn:hover {
            color: #FF69B4;
        }
        #terms-modal .terms-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            font-size: 14px;
            line-height: 1.6;
        }
        #terms-modal .terms-content h3 {
            font-size: 18px;
            margin: 15px 0 10px;
            color: #6A0DAD;
        }
        #terms-modal .terms-content p {
            margin: 10px 0;
        }
        #terms-modal .terms-content ul {
            margin: 10px 0;
            padding-right: 20px;
        }
        #terms-modal .terms-content li {
            margin: 5px 0;
        }
        .error-message {
            text-align: center;
            font-size: 18px;
            color: #FF69B4;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>إتمام الشراء</h1>
        <div class="order-summary">
            <h2>ملخص الطلب</h2>
            <div id="order-details">
                <table id="order-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>السعر</th>
                            <th>الكمية</th>
                            <th>الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body"></tbody>
                </table>
            </div>
            <div class="notes-display" id="order-notes-section" style="display: none;">
                <h3>ملاحظات الطلب:</h3>
                <p id="order-notes"></p>
            </div>
            <div class="summary-details">
                <p>السعر الإجمالي: <span id="total-amount">0</span> ر.ع</p>
            </div>
        </div>
        <div class="checkout-form">
            <h2>معلومات الدفع</h2>
            <form id="checkout-form">
                <div class="form-group name">
                    <input type="text" id="name" placeholder="الاسم الكامل" required>
                </div>
                <div class="form-group email">
                    <input type="email" id="email" placeholder="البريد الإلكتروني" required>
                </div>
                <div class="form-group phone">
                    <input type="tel" id="phone" placeholder="رقم الهاتف" required pattern="[0-9]{8,15}">
                </div>
                <div class="payment-methods">
                    <h3>طريقة الدفع</h3>
                    <label><input type="radio" name="payment" value="بطاقة ائتمان" required> بطاقة ائتمان</label>
                    <label><input type="radio" name="payment" value="Apple Pay"> Apple Pay</label>
                    <label><input type="radio" name="payment" value="Google Pay"> Google Pay</label>
                </div>
                <div id="terms">
                    <input type="checkbox" id="agree-terms">
                    <label for="agree-terms">أوافق على <a onclick="openTermsModal()">الشروط والأحكام</a></label>
                </div>
                <button id="submit-btn" disabled>إرسال الطلب</button>
                <button type="button" class="back-btn" onclick="window.location.href='index.html'">العودة إلى الصفحة الرئيسية</button>
            </form>
        </div>
    </div>

    <div id="terms-modal">
        <div>
            <span class="close-btn" onclick="closeTermsModal()">✖</span>
            <h2>الشروط والأحكام</h2>
            <div class="terms-content">
                <h3>1. مقدمة</h3>
                <p>مرحبًا بكم في موقع tkchop.om. نحن متجر إلكتروني متخصص في بيع المنتجات الرقمية مثل الألعاب الإلكترونية والبرامج. باستخدام هذا الموقع، فإنك توافق على الالتزام بالشروط والأحكام التالية. يرجى قراءتها بعناية قبل إتمام أي عملية شراء.</p>
                <h3>2. شروط الشراء</h3>
                <p>جميع المنتجات المعروضة على الموقع هي منتجات رقمية (مثل الألعاب الإلكترونية أو البرامج) ويتم تسليمها عبر البريد الإلكتروني أو رابط تحميل بعد إتمام الدفع بنجاح.</p>
                <ul>
                    <li>يجب أن تكون جميع المعلومات المقدمة (مثل الاسم، البريد الإلكتروني، رقم الهاتف) دقيقة وكاملة.</li>
                    <li>الأسعار المعروضة هي الأسعار النهائية ولا تشمل أي ضرائب إضافية أو رسوم شحن لأن المنتجات رقمية.</li>
                    <li>الدفع يتم عبر الطرق المتاحة (بطاقة ائتمان، Apple Pay، Google Pay).</li>
                </ul>
                <h3>3. تسليم المنتجات الرقمية</h3>
                <p>بعد إتمام الدفع بنجاح، سيتم إرسال رابط التحميل أو مفتاح التنشيط إلى البريد الإلكتروني المقدم خلال 24 ساعة. يرجى التحقق من مجلد الرسائل غير المرغوب فيها (Spam) إذا لم تتلق الرسالة.</p>
                <p>نحن غير مسؤولين عن أي تأخير ناتج عن إدخال بريد إلكتروني غير صحيح من قبل العميل.</p>
                <h3>4. سياسة الإرجاع والاسترداد</h3>
                <p>نظرًا لطبيعة المنتجات الرقمية، لا يمكن إرجاع المنتجات أو استرداد قيمتها بعد إرسال مفتاح التنشيط أو رابط التحميل، إلا في الحالات التالية:</p>
                <ul>
                    <li>إذا كان مفتاح التنشيط غير صالح أو لا يعمل.</li>
                    <li>إذا لم يتم تسليم المنتج خلال 48 ساعة من الدفع.</li>
                </ul>
                <p>في هذه الحالات، يرجى التواصل معنا خلال 7 أيام من تاريخ الشراء لتقديم طلب استرداد.</p>
                <h3>5. التراخيص والاستخدام</h3>
                <p>جميع المنتجات الرقمية المباعة تخضع لشروط الترخيص الخاصة بالمطور أو الناشر. بمجرد شراء المنتج، فإنك توافق على استخدامه وفقًا لشروط الترخيص هذه. لا يُسمح بإعادة بيع أو توزيع مفاتيح التنشيط أو المنتجات الرقمية دون إذن مسبق.</p>
                <h3>6. الخصوصية</h3>
                <p>نحن ملتزمون بحماية بياناتك الشخصية. لن يتم مشاركة معلوماتك مع أي طرف ثالث دون موافقتك، باستثناء ما هو ضروري لإتمام عملية الشراء وتسليم المنتج الرقمي.</p>
                <h3>7. التعديلات على الشروط</h3>
                <p>نحتفظ بالحق في تعديل هذه الشروط والأحكام في أي وقت. سيتم تطبيق النسخة المحدثة على جميع الطلبات المقدمة بعد التعديل.</p>
                <h3>8. التواصل</h3>
                <p>إذا كان لديك أي استفسار حول هذه الشروط، يمكنك التواصل معنا عبر الواتساب على الرقم: 96879470467.</p>
            </div>
        </div>
    </div>

<script>
    const selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];

    window.onload = function() {
        console.log('Selected Items:', selectedItems);
        displayOrderDetails();
        document.querySelector('.container').classList.add('visible');
    };

    function sanitizeInput(input) {
        return input.replace(/[<>&"'']/g, '');
    }

    function displayOrderDetails() {
        const orderBody = document.getElementById('order-table-body');
        const totalAmountElement = document.getElementById('total-amount');
        orderBody.innerHTML = '';

        if (!selectedItems || selectedItems.length === 0) {
            orderBody.innerHTML = '<tr><td colspan="4" class="error-message">لا توجد منتجات في السلة. يرجى العودة إلى الصفحة الرئيسية وإضافة منتجات.</td></tr>';
            totalAmountElement.innerText = '0';
            console.log('No items found in selectedItems');
            return;
        }

        selectedItems.forEach(item => {
            const totalItemPrice = (item.price * item.quantity).toFixed(2);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${sanitizeInput(item.image)}" alt="${sanitizeInput(item.name)}"> ${sanitizeInput(item.name)}</td>
                <td>${item.price} ر.ع</td>
                <td>${item.quantity}</td>
                <td>${totalItemPrice} ر.ع</td>
            `;
            orderBody.appendChild(row);
        });
        updateSummary();

        const orderNotes = localStorage.getItem('orderNotes');
        if (orderNotes) {
            document.getElementById('order-notes-section').style.display = 'block';
            document.getElementById('order-notes').innerText = sanitizeInput(orderNotes);
        }
    }

    function updateSummary() {
        const total = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        document.getElementById('total-amount').innerText = total.toFixed(2);
    }

    document.getElementById('agree-terms').addEventListener('change', function() {
        document.getElementById('submit-btn').disabled = !this.checked;
    });

    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = sanitizeInput(document.getElementById('name').value.trim());
        const email = sanitizeInput(document.getElementById('email').value.trim());
        const phone = sanitizeInput(document.getElementById('phone').value.trim());
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        if (!name || !email || !phone || !/^[0-9]{8,15}$/.test(phone)) {
            return; // لا رسائل، بس ما يكمل التنفيذ
        }
        if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
            return; // لا رسائل، بس ما يكمل التنفيذ
        }

        const totalPrice = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
        const purchaseDate = new Date().toLocaleString('ar', { timeZone: 'Asia/Muscat' });
        const orderNotes = localStorage.getItem('orderNotes') || 'لا توجد ملاحظات';

        let message = `📦 *طلب جديد من tkchop.om* 📦\n\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `👤 *معلومات العميل*\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `- *الاسم*: ${name}\n`;
        message += `- *البريد الإلكتروني*: ${email}\n`;
        message += `- *رقم الهاتف*: ${phone}\n\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `💳 *تفاصيل الدفع*\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `- *طريقة الدفع*: ${paymentMethod}\n`;
        message += `- *تاريخ الشراء*: ${purchaseDate}\n\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `🛒 *المنتجات المطلوبة*\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        selectedItems.forEach((item, index) => {
            message += `${index + 1}. ${sanitizeInput(item.name)}\n`;
            message += `   - السعر: ${item.price} ر.ع\n`;
            message += `   - الكمية: ${item.quantity}\n`;
            message += `   - الإجمالي: ${(item.price * item.quantity).toFixed(2)} ر.ع\n`;
        });
        message += `\n━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `📝 *ملاحظات الطلب*\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `${sanitizeInput(orderNotes)}\n\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
        message += `💰 *السعر الإجمالي*: ${totalPrice} ر.ع\n`;
        message += `━━━━━━━━━━━━━━━━━━━━━━\n`;

        const whatsappUrl = `https://wa.me/96879470467?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        localStorage.removeItem('selectedItems');
        localStorage.removeItem('orderNotes');
        window.close();
    });

    function openTermsModal() {
        const modal = document.getElementById('terms-modal');
        modal.classList.add('active');
    }

    function closeTermsModal() {
        const modal = document.getElementById('terms-modal');
        modal.classList.remove('active');
    }
</script>
</body>
</html